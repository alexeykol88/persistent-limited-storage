{"version":3,"file":"limitedstorage.es5.js","sources":["../src/storageNode.ts","../node_modules/sizeof/lib/sizeof.js","../node_modules/sizeof/index.js","../src/limitedstorage.ts"],"sourcesContent":["//template for storage node\nexport class StorageNode {\n    key: string;\n    value: any;\n    prev: StorageNode | null;\n    next: StorageNode | null;\n    \n    constructor(key: string, value: any){\n      this.key = key;\n      this.value = value;\n      this.prev = null;\n      this.next = null;\n    }\n}","var sizeof = sizeof || {};\r\nsizeof.sizeof = function(object, pretty) {\r\n    var objectList = [];\r\n    var stack = [object];\r\n    var bytes = 0;\r\n\r\n    while (stack.length) {\r\n        var value = stack.pop();\r\n\r\n        if(typeof value === 'boolean'){\r\n            bytes += 4;\r\n        }else if(typeof value === 'string'){\r\n            bytes += value.length * 2;\r\n        }else if(typeof value === 'number'){\r\n            bytes += 8;\r\n        }else if(typeof value === 'object' && objectList.indexOf( value ) === -1){\r\n            objectList.push(value);\r\n            // if the object is not an array, add the sizes of the keys\r\n            if (Object.prototype.toString.call(value) != '[object Array]'){\r\n                for(var key in value) bytes += 2 * key.length;\r\n            }\r\n            for(var key in value) stack.push(value[key]);\r\n        }\r\n    }\r\n    return pretty ? sizeof.format(bytes) : bytes;\r\n}\r\nsizeof.format = function(bytes){\r\n    if(bytes < 1024) return bytes + \"B\";\r\n    else if(bytes < 1048576) return(bytes / 1024).toFixed(3) + \"K\";\r\n    else if(bytes < 1073741824) return(bytes / 1048576).toFixed(3) + \"M\";\r\n    else return(bytes / 1073741824).toFixed(3) + \"G\";\r\n}\r\nexports = module.exports = sizeof;","\r\nexports = module.exports = require('./lib/sizeof');","  import {IStorage, IStorageParams} from 'store';\r\n  import {StorageNode} from './storageNode';\r\n  import 'sizeof';\r\n\r\n  interface IStore {\r\n    [key: string]: any;\r\n  }\r\n\r\n  export class Storage implements IStorage {\r\n    private head : StorageNode | null;\r\n    private tail: StorageNode | null;\r\n    private store : IStore;\r\n    private limit : number;\r\n    private sizeof : any;\r\n    private useLocalStorage: boolean;\r\n    private globalKey : string;\r\n\r\n  constructor(params: IStorageParams) {\r\n    this.limit = params.limit;\r\n    if (params.useLocalStorage && params.limit > 10 * 1024 * 1024) {\r\n      this.limit = 10 * 1024 * 1024;\r\n      console.warn(\"Max limit for local storage is 10mb, your storage limit set to 10mb.\")\r\n      }\r\n    this.useLocalStorage = params.useLocalStorage;\r\n    this.globalKey = params.globalKey;\r\n    this.sizeof = require('sizeof').sizeof;\r\n    this.store = {};\r\n    this.head = null;\r\n    this.tail = null;\r\n    if (this.useLocalStorage) {\r\n      this.getDataFromLocalStorage();\r\n    }\r\n  }\r\n\r\n  public getFreeSpace() {\r\n    return this.limit - this.sizeof(this.store);\r\n  }\r\n\r\n  public set(key: string, value: any): void {\r\n      const node = new StorageNode(key, value);\r\n      const size = this.sizeof(node);\r\n      \r\n      if (this.limit < size) {\r\n      return;\r\n      }\r\n\r\n      if (this.store[node.key]) {\r\n        this.store[node.key].value = value;\r\n        this.remove(node.key);\r\n      }\r\n       \r\n      while (this.getFreeSpace() < size) {\r\n        if (this.tail !== null) {\r\n          this.remove(this.tail.key);\r\n        }\r\n        else {\r\n          return;\r\n        }\r\n      }\r\n\r\n      this.setHead(node);\r\n\r\n      if (this.useLocalStorage) {\r\n        this.setToLocalStorage();\r\n      }\r\n  }\r\n  \r\n  private setToLocalStorage(): any {\r\n    const storeToSave = Object.keys(this.store).map(key => \r\n      ({ key: key, value: this.store[key].value })).reduce(\r\n        (f, s) => { f[s.key] = s; return f; }, {} as IStore)\r\n        localStorage.setItem(this.globalKey, JSON.stringify(storeToSave))\r\n  } \r\n\r\n  public get(key: string): any{\r\n\r\n    if (!this.store[key]) {\r\n      return null;\r\n    }\r\n\r\n    return this.store[key].value;\r\n  }\r\n\r\n  private getDataFromLocalStorage(): any {\r\n     const fromLS = JSON.parse(localStorage.getItem(this.globalKey) || \"{}\");\r\n     Object.keys(fromLS).forEach(key => {\r\n      this.set(key, fromLS[key].value);\r\n    });\r\n  }\r\n\r\n  public remove(key: string): any {\r\n     const node = this.store[key];\r\n     \r\n     if(!node){\r\n       return null;\r\n     }\r\n      \r\n     let value = JSON.parse(JSON.stringify(node.value));\r\n\r\n     if (node.prev !== null) {\r\n       node.prev.next = node.next;\r\n     }\r\n     else {\r\n       this.head = node.next;\r\n     }\r\n\r\n     if(node.next !==  null) {\r\n       node.next.prev = node.prev;\r\n     }\r\n     else {\r\n       this.tail = node.prev;\r\n     }\r\n\r\n     delete this.store[key];\r\n\r\n     if (this.useLocalStorage) {\r\n      this.setToLocalStorage();\r\n   }\r\n\r\n   return value;\r\n  }\r\n\r\n  public clearStorage() {\r\n    this.store = {};\r\n    this.head = null;\r\n    this.tail = null;\r\n\r\n    if (this.useLocalStorage) {\r\n      this.setToLocalStorage();\r\n    }\r\n  }\r\n\r\n  private setHead(node: StorageNode) {\r\n    node.next = this.head;\r\n    node.prev = null;\r\n\r\n    if (this.head !== null) {\r\n      this.head.prev = node;\r\n    }\r\n    this.head = node;\r\n\r\n    if (this.tail === null) {\r\n      this.tail = node;\r\n    }\r\n    this.store[node.key] = node;\r\n  }\r\n}\r\n"],"names":["require$$0"],"mappings":"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"}